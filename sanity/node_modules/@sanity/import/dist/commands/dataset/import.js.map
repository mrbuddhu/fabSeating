{"version":3,"sources":["../../../src/commands/dataset/import.ts"],"sourcesContent":["import {Args, Flags} from '@oclif/core'\nimport {getProjectCliClient, SanityCommand} from '@sanity/cli-core'\nimport {spinner} from '@sanity/cli-core/ux'\nimport fs from 'fs'\nimport {getIt} from 'get-it'\nimport {promise} from 'get-it/middleware'\nimport path from 'path'\nimport prettyMs from 'pretty-ms'\n\nimport {sanityImport} from '../../import.js'\nimport type {ImportOptions, ProgressEvent} from '../../types.js'\n\nfunction getAssetsBase(source: string): string | undefined {\n  if (/^https:\\/\\//i.test(source) || source === '-') {\n    return undefined\n  }\n\n  try {\n    const fileStats = fs.statSync(source)\n    const sourceIsFolder = fileStats.isDirectory()\n    return sourceIsFolder ? source : path.dirname(source)\n  } catch {\n    return undefined\n  }\n}\n\nasync function getUriStream(uri: string): Promise<NodeJS.ReadableStream> {\n  const request = getIt([promise()])\n\n  try {\n    const response = (await request({url: uri, stream: true})) as {body: NodeJS.ReadableStream}\n    return response.body\n  } catch (err) {\n    throw new Error(`Error fetching source:\\n${(err as Error).message}`)\n  }\n}\n\nfunction getPercentage(opts: ProgressEvent): string {\n  if (!opts.total) {\n    return ''\n  }\n\n  const percent = Math.floor(((opts.current || 0) / opts.total) * 100)\n  return `[${percent}%] `\n}\n\nexport class DatasetImportCommand extends SanityCommand<typeof DatasetImportCommand> {\n  static override description = 'Import documents to a Sanity dataset'\n\n  static override examples = [\n    {\n      description: 'Import \"./my-dataset.ndjson\" into dataset \"staging\"',\n      command:\n        '<%= config.bin %> <%= command.id %> -p myPrOj -d staging -t someSecretToken my-dataset.ndjson',\n    },\n    {\n      description: 'Import into dataset \"test\" from stdin, read token from env var',\n      command: 'cat my-dataset.ndjson | <%= config.bin %> <%= command.id %> -p myPrOj -d test -',\n    },\n  ]\n\n  static override flags = {\n    project: Flags.string({\n      char: 'p',\n      description: 'Project ID to import to',\n      required: true,\n    }),\n    dataset: Flags.string({\n      char: 'd',\n      description: 'Dataset to import to',\n      required: true,\n    }),\n    token: Flags.string({\n      char: 't',\n      description: 'Token to authenticate with',\n      required: false,\n      env: 'SANITY_IMPORT_TOKEN',\n    }),\n    replace: Flags.boolean({\n      description: 'Replace documents with the same IDs',\n      default: false,\n      exclusive: ['missing'],\n    }),\n    missing: Flags.boolean({\n      description: 'Skip documents that already exist',\n      default: false,\n      exclusive: ['replace'],\n    }),\n    'allow-failing-assets': Flags.boolean({\n      description: 'Skip assets that cannot be fetched/uploaded',\n      default: false,\n    }),\n    'allow-assets-in-different-dataset': Flags.boolean({\n      description: 'Allow asset documents to reference different project/dataset',\n      default: false,\n    }),\n    'replace-assets': Flags.boolean({\n      description: 'Skip reuse of existing assets',\n      default: false,\n    }),\n    'skip-cross-dataset-references': Flags.boolean({\n      description: 'Skips references to other datasets',\n      default: false,\n    }),\n    'allow-system-documents': Flags.boolean({\n      description: 'Imports system documents',\n      default: false,\n    }),\n    'asset-concurrency': Flags.integer({\n      description: 'Number of parallel asset imports',\n    }),\n  }\n\n  static override args = {\n    source: Args.string({\n      description: 'Source file (use \"-\" for stdin)',\n      required: true,\n    }),\n  }\n\n  private currentStep?: string\n  private currentProgress?: ReturnType<typeof spinner>\n  private stepStart?: number\n  private spinInterval?: NodeJS.Timeout | null\n\n  public async run(): Promise<void> {\n    const {args, flags} = await this.parse(DatasetImportCommand)\n\n    const {\n      project: projectId,\n      dataset,\n      token,\n      replace,\n      missing,\n      'allow-failing-assets': allowFailingAssets,\n      'allow-assets-in-different-dataset': allowAssetsInDifferentDataset,\n      'replace-assets': replaceAssets,\n      'skip-cross-dataset-references': skipCrossDatasetReferences,\n      'allow-system-documents': allowSystemDocuments,\n      'asset-concurrency': assetConcurrency,\n    } = flags\n\n    const {source} = args\n\n    const tokenString: string | undefined = token\n    if (!tokenString) {\n      this.error('Flag `--token` is required (or set SANITY_IMPORT_TOKEN)', {exit: 1})\n    }\n\n    let operation: 'create' | 'createIfNotExists' | 'createOrReplace' = 'create'\n    let releasesOperation: 'fail' | 'ignore' | 'replace' = 'fail'\n\n    if (replace || missing) {\n      operation = replace ? 'createOrReplace' : 'createIfNotExists'\n      releasesOperation = replace ? 'replace' : 'ignore'\n    }\n\n    const client = await getProjectCliClient({\n      apiVersion: 'v2025-02-19',\n      projectId,\n      dataset,\n      token: tokenString,\n    })\n\n    try {\n      const stream = await DatasetImportCommand.getStream(source)\n      const assetsBase = getAssetsBase(source)\n\n      const importOptions: ImportOptions = {\n        client,\n        operation,\n        onProgress: this.onProgress.bind(this),\n        allowFailingAssets: allowFailingAssets || false,\n        allowAssetsInDifferentDataset: allowAssetsInDifferentDataset || false,\n        skipCrossDatasetReferences: skipCrossDatasetReferences || false,\n        allowSystemDocuments: allowSystemDocuments || false,\n        replaceAssets: replaceAssets || false,\n        releasesOperation,\n        tag: 'sanity.import',\n        targetProjectId: projectId,\n        targetDataset: dataset,\n      }\n\n      if (assetsBase) {\n        importOptions.assetsBase = assetsBase\n      }\n\n      if (assetConcurrency !== undefined) {\n        importOptions.assetConcurrency = assetConcurrency\n      }\n\n      const {numDocs, warnings} = await sanityImport(stream as NodeJS.ReadableStream, importOptions)\n\n      if (this.stepStart) {\n        const timeSpent = prettyMs(Date.now() - this.stepStart, {secondsDecimalDigits: 2})\n        if (this.currentProgress) {\n          this.currentProgress.text = `[100%] ${this.currentStep} (${timeSpent})`\n          this.currentProgress.succeed()\n        }\n      }\n\n      this.log('Done! Imported %d documents to dataset \"%s\"\\n', numDocs, dataset)\n      this.printWarnings(warnings)\n    } catch (err) {\n      if (this.currentProgress) {\n        this.currentProgress.fail()\n      }\n\n      this.error((err as Error).stack || (err as Error).message, {exit: 1})\n    }\n  }\n\n  private printWarnings(warnings: Array<{message: string; type?: string; url?: string}>): void {\n    const assetFails = warnings.filter((warn) => warn.type === 'asset')\n\n    if (!assetFails.length) {\n      return\n    }\n\n    this.warn(`Failed to import the following ${assetFails.length > 1 ? 'assets' : 'asset'}:`)\n\n    warnings.forEach((warning) => {\n      this.warn(`  ${warning.url}`)\n    })\n  }\n\n  private static async getStream(source: string): Promise<ReadableStream | NodeJS.ReadableStream> {\n    if (/^https:\\/\\//i.test(source)) {\n      return getUriStream(source)\n    }\n\n    return source === '-' ? process.stdin : fs.createReadStream(source)\n  }\n\n  private onProgress(opts: ProgressEvent): void {\n    const lengthComputable = opts.total\n    const sameStep = opts.step === this.currentStep\n    const percent = getPercentage(opts)\n\n    if (lengthComputable && opts.total === opts.current) {\n      if (this.spinInterval) {\n        clearInterval(this.spinInterval)\n        this.spinInterval = null\n      }\n    }\n\n    if (sameStep && !lengthComputable) {\n      return\n    }\n\n    if (sameStep) {\n      if (this.stepStart) {\n        const timeSpent = prettyMs(Date.now() - this.stepStart, {secondsDecimalDigits: 2})\n        if (this.currentProgress) {\n          this.currentProgress.text = `${percent}${opts.step} (${timeSpent})`\n          this.currentProgress.render()\n        }\n      }\n      return\n    }\n\n    // Moved to a new step\n    const prevStep = this.currentStep\n    const prevStepStart = this.stepStart\n    this.stepStart = Date.now()\n    this.currentStep = opts.step\n\n    if (this.spinInterval) {\n      clearInterval(this.spinInterval)\n      this.spinInterval = null\n    }\n\n    if (this.currentProgress && this.currentProgress.succeed && prevStepStart) {\n      const timeSpent = prettyMs(Date.now() - prevStepStart, {\n        secondsDecimalDigits: 2,\n      })\n      this.currentProgress.text = `[100%] ${prevStep} (${timeSpent})`\n      this.currentProgress.succeed()\n    }\n\n    this.currentProgress = spinner(`[0%] ${opts.step} (0.00s)`).start()\n\n    if (!lengthComputable) {\n      this.spinInterval = setInterval(() => {\n        if (this.stepStart && this.currentProgress) {\n          const timeSpent = prettyMs(Date.now() - this.stepStart, {\n            secondsDecimalDigits: 2,\n          })\n          this.currentProgress.text = `${percent}${opts.step} (${timeSpent})`\n          this.currentProgress.render()\n        }\n      }, 60)\n    }\n  }\n}\n"],"names":["Args","Flags","getProjectCliClient","SanityCommand","spinner","fs","getIt","promise","path","prettyMs","sanityImport","getAssetsBase","source","test","undefined","fileStats","statSync","sourceIsFolder","isDirectory","dirname","getUriStream","uri","request","response","url","stream","body","err","Error","message","getPercentage","opts","total","percent","Math","floor","current","DatasetImportCommand","description","examples","command","flags","project","string","char","required","dataset","token","env","replace","boolean","default","exclusive","missing","integer","args","currentStep","currentProgress","stepStart","spinInterval","run","parse","projectId","allowFailingAssets","allowAssetsInDifferentDataset","replaceAssets","skipCrossDatasetReferences","allowSystemDocuments","assetConcurrency","tokenString","error","exit","operation","releasesOperation","client","apiVersion","getStream","assetsBase","importOptions","onProgress","bind","tag","targetProjectId","targetDataset","numDocs","warnings","timeSpent","Date","now","secondsDecimalDigits","text","succeed","log","printWarnings","fail","stack","assetFails","filter","warn","type","length","forEach","warning","process","stdin","createReadStream","lengthComputable","sameStep","step","clearInterval","render","prevStep","prevStepStart","start","setInterval"],"mappings":"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"}